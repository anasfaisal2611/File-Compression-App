import json
import hashlib
import random
import string
from abc import ABC, abstractmethod
from datetime import datetime
import requests






# Define Car class to handle all car-related operations
class Car:
    def __init__(self):
        self.car_info = ['Car name', 'Number plate', 'Seating capacity', 'Price per day', 'Status']
        self.filename = 'garage.json'

    # Add a new car to the garage
    def add_car(self):
        while True:
            try:
                # Ask for Car ID until a valid 6-digit number is given
                car_id = input('Enter Car ID (6 digit number): ')
                if len(car_id) != 6 or not car_id.isdigit():
                    raise ValueError('Car ID must be exactly 6 digits.')
                break
            except ValueError as e:
                print('Error:', e)

        # Load garage data or create empty if file doesn't exist
        try:
            with open(self.filename, 'r') as f:
                inv = json.load(f)
        except (FileNotFoundError, json.decoder.JSONDecodeError):
            inv = {}

        # Ask for car name and number plate
        Car_name = input(f'Enter Car Name (Brand) for {car_id}: ')
        Number_plate = input(f'Enter Number Plate for {car_id}: ')

        while True:
            try:
                # Ask for seating capacity until valid input
                Seating_capacity = int(input('Enter Seating Capacity: '))
                if Seating_capacity <= 0:
                    raise ValueError('Seating capacity must be a positive number.')
                break
            except ValueError as e:
                print('Error:', e)

        while True:
            try:
                # Ask for price per day until valid input
                price = int(input('Enter Rent per Day: '))
                if price <= 0:
                    raise ValueError('Price must be positive.')
                break
            except ValueError as e:
                print('Error:', e)

        # Save car information into JSON file
        inv[car_id] = [Car_name, Number_plate, Seating_capacity, price, 'Not reserved']
        with open(self.filename, 'w') as f:
            json.dump(inv, f, indent=4)

    # Remove car using car ID
    def remove_car(self, car_id):
        try:
            with open(self.filename, 'r') as f:
                inv = json.load(f)
            if car_id in inv:
                del inv[car_id]
                with open(self.filename, 'w') as f:
                    json.dump(inv, f, indent=4)
                print(f'Car {car_id} removed.')
            else:
                print('Car ID not found.')
        except Exception as e:
            print('Error:', e)

    # Return the entire garage as dictionary
    def show_garage(self):
        try:
            with open(self.filename, 'r') as f:
                return json.load(f)
        except:
            return {}

    # Print all car details
    def display_details(self):
        garage = self.show_garage()
        if garage:
            for car_id, details in garage.items():
                print(f"Car ID: {car_id}, Details: {details}")
        else:
            print("Garage is empty.")

# Abstract base class for person
class Person(ABC):
    def __init__(self):
        self.ur_name = None
        self.pss = None
        self.id = None
        self.first_name = None
        self.second_name = None
        self.address = None

    @abstractmethod
    def login(self): pass

    @abstractmethod
    def create_acc(self): pass

# Administrator class inheriting from Person
class Administrator(Person):
    admin_file = "admin.json"

    def __init__(self):
        super().__init__()
        self.car = Car()

    def create_acc(self):
        self.ur_name = input("Enter Username: ")
        while True:
            try:
                self.pss = input("Enter Password: ")
                if len(self.pss) < 8:
                    raise ValueError("Password must be 8+ characters.")
                self.pss = hashlib.sha256(self.pss.encode()).hexdigest()
                break
            except ValueError as e:
                print(e)

        self.first_name = input("Enter First Name: ")
        self.second_name = input("Enter Last Name: ")

        try:
            with open(self.admin_file, 'r') as f:
                data = json.load(f)
        except:
            data = {}

        # Generate random admin ID
        self.id = ''.join(random.choices(string.ascii_uppercase + string.digits, k=6))
        data[self.id] = {"username": self.ur_name, "password": self.pss, "First Name": self.first_name, "Last Name": self.second_name}
        with open(self.admin_file, 'w') as f:
            json.dump(data, f, indent=4)

    def login(self):
        ur_name = input("Username: ")
        psw = hashlib.sha256(input("Password: ").encode()).hexdigest()
        try:
            with open(self.admin_file, 'r') as f:
                acc_data = json.load(f)
        except:
            return False

        for info in acc_data.values():
            if info["username"] == ur_name and info["password"] == psw:
                print("Admin Login successful!")
                return True
        print("Invalid credentials")
        return False

    def generate_reserved_cars_report(self):
        garage = self.car.show_garage()
        print("\n--- Reserved Cars Report ---")
        for cid, details in garage.items():
            if details[-1] == "Reserved":
                print(f"Car ID: {cid}, Details: {details}")

    def generate_customer_report(self):
        try:
            with open("user.json", "r") as f:
                users = json.load(f)
            print("\n--- Customer Report ---")
            for uid, details in users.items():
                print(f"User ID: {uid}, Username: {details['username']}")
        except:
            print("No customer data available.")

# User class for customer
class User(Person):
    user_file = "user.json"

    def __init__(self):
        super().__init__()

    def create_acc(self):
        self.ur_name = input("Enter Username: ")
        while True:
            try:
                self.pss = input("Enter Password: ")
                if len(self.pss) < 8:
                    raise ValueError("Password too short.")
                self.pss = hashlib.sha256(self.pss.encode()).hexdigest()
                break
            except ValueError as e:
                print(e)

        self.first_name = input("First Name: ")
        self.second_name = input("Last Name: ")
        self.address = input("Address: ")

        try:
            with open(self.user_file, 'r') as f:
                data = json.load(f)
        except:
            data = {}

        # Generate random user ID
        self.id = ''.join(random.choices(string.ascii_uppercase + string.digits, k=6))
        data[self.id] = {"username": self.ur_name, "password": self.pss, "First Name": self.first_name, "Last Name": self.second_name, "Address": self.address}
        with open(self.user_file, 'w') as f:
            json.dump(data, f, indent=4)

    def login(self):
        uname = input("Enter Username: ")
        psw = hashlib.sha256(input("Enter Password: ").encode()).hexdigest()
        try:
            with open(self.user_file, 'r') as f:
                data = json.load(f)
        except:
            return False, None

        for uid, info in data.items():
            if info['username'] == uname and info['password'] == psw:
                print("User Login successful!")
                return uid, uname
        print("Login failed.")
        return False, None


class MockPaymentAPI:
    def __init__(self):
        self.file = "cards.json"
        self.load_cards()

    def load_cards(self):
        try:
            with open(self.file, mode='r') as f:
                self.card_balance = json.load(f)
        except FileNotFoundError:
            print("File not found. Initializing with default cards.")
        self.card_balance = {"4242424242424242": 50000,"1111222233334444": 10000}
        self.save_cards()

    def save_cards(self):
        with open(self.file, mode='w') as f:
            json.dump(self.card_balance, f, indent=4)

    def process_payment(self, card_no, amount):
        if card_no not in self.card_balance:
            return {"success": False, "message": "Card not recognized"}

        if self.card_balance[card_no] < amount:
            return {"success": False, "message": "Insufficient Funds"}

        self.card_balance[card_no] -= amount
        self.save_cards()  # Save updated balance
        return {"success": True, "message": "Payment Successful"}


# Class to manage car rentals
class Rental:
    rental_file = "rentals.json"


    def __init__(self, rental_id=None, user_id=None, car_id=None, start_date=None, end_date=None):
        self.rental_id = rental_id or ''.join(random.choices(string.ascii_uppercase + string.digits, k=6))
        self.user_id = user_id
        self.car_id = car_id
        self.start_date = start_date
        self.end_date = end_date
        self.rental_amount = 0.0
        self.return_status="active"
        self.car = Car()

    def calculate_rent(self):
        garage = self.car.show_garage()
        if self.car_id not in garage:
            print("Invalid car ID.")
            return False
        print("a) Package 1 5% Discount}")
        print('b) Package 2: 10% DIscount}')
        print("c) Package 3: 20% Discount}")

        try:
            choice=input(" Do you want to avail any of our Packages? (yes/no): ")

            start = datetime.strptime(self.start_date, "%Y-%m-%d")
            end = datetime.strptime(self.end_date, "%Y-%m-%d")
            days = (end - start).days + 1
            if days <= 0:
              raise ValueError("End date must be after start date.")




            price_per_day = float(garage[self.car_id][3])
            rent=price_per_day*days


            if choice=="no":
                self.rental_amount=rent
                return True,self.rental_amount
            choice2=input("Enter a,b or c for the package you want: ").strip().lower()
            package_map = {
                "a": {"days": 2, "discount": 0.05},
                "b": {"days": 7, "discount": 0.10},
                "c": {"days": 30, "discount": 0.20},
            }
            if choice2 not in package_map:
                print("Invalid choice")
                return False,0.00
            expected_days = package_map[choice2]["days"]
            discount = package_map[choice2]["discount"]

            if days != expected_days:
                print(f"Selected package requires exactly {expected_days} days.")
                return False, 0.0

            discounted_rent = rent * (1 - discount)
            self.rental_amount = discounted_rent
            return True, self.rental_amount


        except Exception as e:
         print("Error in calculating rent:", e)
         return False, 0.0




    def display_rental_info(self):
        print(f"Rental ID: {self.rental_id}")
        print(f"User ID: {self.user_id}")
        print(f"Car ID: {self.car_id}")
        print(f"Start Date: {self.start_date}")
        print(f"End Date: {self.end_date}")
        print(f"Rental Amount: ${self.rental_amount:.2f}")
        print(f"Return Status: {self.return_status}")

    def save_rental(self):
        try:
            with open(self.rental_file, 'r') as f:
                data = json.load(f)
        except (FileNotFoundError, json.decoder.JSONDecodeError):
            data = []

        data.append({"rental_id": self.rental_id, "user_id": self.user_id, "car_id": self.car_id, "start_date": self.start_date, "end_date": self.end_date, "rental_amount": self.rental_amount,"return status":self.return_status})
        with open(self.rental_file, 'w') as f:
            json.dump(data, f, indent=4)

    @staticmethod
    def show_user_rentals(user_id):
        try:
            with open(Rental.rental_file, 'r') as f:
                rentals = json.load(f)
        except:
            rentals = []

        user_rentals = [r for r in rentals if r['user_id'] == user_id]
        if user_rentals:
            print("\n--- Rental History ---")
            for r in user_rentals:
                print(f"Rental ID: {r['rental_id']}, Car ID: {r['car_id']}, From: {r['start_date']} To: {r['end_date']}, Amount: ${r['rental_amount']:.2f}")
        else:
            print("No rentals found.")
    def user_active_rental(self,user):
        try:
            with open(Rental.rental_file,"r") as f:
                rentals=json.load(f)
            for r in rentals:
                if r["user_id"]==user and not r.get("returned,False"):
                    return True
        except:
            pass
        return False
    def load_rentals(self):
        try:

            with open(Rental.rental_file,"r") as f:
                data=json.load(f)
                return data
        except FileNotFoundError:
            print("File Not found")
            return []
    def return_car(self,actual_return_date):
        history=self.load_rentals()
        garage=self.car.show_garage()
        returned=False
        for rental in history:
            if rental["user_id"]==self.user_id and rental["car_id"]==self.car_id and rental["rental status"]=="active":
                rental["actual_return_date"]=actual_return_date
                planned_return=datetime.strptime((rental["end_date"],"%Y-%m-%d"))
                actual_return=datetime.strptime(actual_return_date,"%Y-%m-%d")

                late_days=(actual_return-planned_return).days
                fine=0
                if late_days>0:
                    price_per_day = float(garage[self.car_id][3])
                    fine = price_per_day * late_days
                    print(f"Late return! You are {late_days} day(s) late. Fine: Rs {fine}")
                    if not self.simulate_payment(fine):
                        print("Fine payment failed. Please resolve to complete return.")
                        return False

            rental["rental status"] = "Returned"
            # rental["fine"] = fine
            returned=True
            break

        if returned:
                # Save updated history
            with open(self.rental_file, "w") as f:
                json.dump(history, f, indent=4)

                # Update car status to Available
            if self.car_id in garage:
                garage[self.car_id][-1] = "Not Reserved"
                with open(self.car.filename, "w") as f:
                    json.dump(garage, f, indent=4)

            print("Car successfully returned.")
            return True
        else:
            print("No active rental found to return.")
            return False









    def simulate_payment(self,amount):
        print("\n ----Payment---")

        card_no= input("Enter your card Number: ").replace(" ","")

        payment_api=MockPaymentAPI()
        result=payment_api.process_payment(card_no,amount)
        if result["success"]:
            print(result["message"])
            return True
        else:
            print(result["message"])
            return False



# Main function to run the application
def main():
    while True:
        print("\n--- Car Rental System ---")
        print("1. Admin Login")
        print("2. User Login")
        print("3. Create Admin Account")
        print("4. Create User Account")
        print("5. View Garage")
        print("6. Exit")

        choice = input("Select an option: ")

        if choice == "1":
            admin = Administrator()
            if admin.login():
                while True:
                    print("\n--- Admin Menu ---")
                    print("1. Add Car")
                    print("2. Remove Car")
                    print("3. Reserved Cars Report")
                    print("4. Customer Report")
                    print("5. Logout")
                    c = input("Choice: ")
                    if c == "1":
                        admin.car.add_car()
                    elif c == "2":
                        admin.car.remove_car(input("Enter Car ID: "))
                    elif c == "3":
                        admin.generate_reserved_cars_report()
                    elif c == "4":
                        admin.generate_customer_report()
                    elif c == "5":
                        break
                    else:
                        print("Invalid choice.")

        elif choice == "2":
            user = User()
            user_id, uname = user.login()
            if user_id:
                while True:
                    print("\n--- User Menu ---")
                    print("1. View Garage")
                    print("2. Rent a Car")
                    print("3. View Rental History")
                    print("4.Return Car")
                    print("5. Logout")
                    c = input("Choice: ")
                    if c == "1":
                        car = Car()
                        car.display_details()
                    # elif c == "2":
                    #     cid = input("Enter Car ID: ")
                    #     while True:
                    #         s_date = input("Start date (YYYY-MM-DD): ")
                    #         e_date = input("End date (YYYY-MM-DD): ")
                    #         rental = Rental(user_id=user_id, car_id=cid, start_date=s_date, end_date=e_date)
                    #         if rental.calculate_rent():
                    #             break
                    elif c == "2":
                        car_obj = Car()
                        garage = car_obj.show_garage()


                        while True:
                            cid = input("Enter Car ID: ")
                            if cid in garage and garage[cid][-1] != "Reserved":
                                break
                            print("Invalid or already reserved Car ID. Please try again.")

                        while True:
                            s_date = input("Start date (YYYY-MM-DD): ")
                            e_date = input("End date (YYYY-MM-DD): ")
                            rental = Rental(user_id=user_id, car_id=cid, start_date=s_date, end_date=e_date)
                            if rental.user_active_rental(user_id):
                                print("You already have an active rental,Return the current car first")
                                break
                            success,rent=rental.calculate_rent()
                            if not success:
                                continue
                            else:
                                break





                        confirm = input("Confirm rental? (yes/no): ").lower()
                        if confirm == "yes":
                            if rental.calculate_rent():
                                rental.display_rental_info()
                                print("Total rent:",rental.rental_amount)
                            if rental.simulate_payment(rental.rental_amount):

                                garage = rental.car.show_garage()
                                if cid in garage:
                                    garage[cid][-1] = "Reserved"
                                    with open(rental.car.filename, "w") as f:
                                        json.dump(garage, f, indent=4)
                                rental.save_rental()
                                print("Car successfully rented!")
                            else:
                                print("Faileddue to payment issue")
                    elif c == "3":
                        Rental.show_user_rentals(user_id)
                    elif c == "4":
                        cid = input("Enter Car ID to return: ")
                        actual_date = input("Enter Today's date(YYYY-MM-DD): ")
                        rental = Rental(user_id=user_id, car_id=cid, start_date="", end_date="")
                        rental.return_car(actual_date)
                    elif c == "5":
                        break
                    else:
                        print("Invalid choice.")

        elif choice == "3":
            admin = Administrator()
            admin.create_acc()

        elif choice == "4":
            user = User()
            user.create_acc()
        elif choice == "5":
            car = Car()
            car.display_details()
        elif choice == "6":
            print("Thank you for using the Car Rental System!")
            break
        else:
            print("Invalid option.")

if __name__ == "__main__":
    main()
